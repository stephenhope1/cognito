<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goal Archive</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 2em; }
        .container { max-width: 900px; margin: auto; }
        h1 { color: #bb86fc; }
        .goal { background-color: #1e1e1e; border-left: 5px solid #444; margin-bottom: 1em; padding: 1.5em; border-radius: 8px; }
        .goal.status-complete { border-left-color: #03dac6; }
        .goal.status-failed, .goal.status-cancelled { border-left-color: #cf6679; }
        .pagination { margin-top: 2em; text-align: center; }
        .pagination a { color: #bb86fc; text-decoration: none; margin: 0 0.5em; padding: 0.5em 1em; border-radius: 4px; }
        .pagination a.current { font-weight: bold; background-color: #373737; }
        .back-link { display: inline-block; margin-bottom: 2em; color: #03dac6; }

        /* --- NEW CSS ADDED --- */
        .details { margin-top: 1.5em; padding-left: 1.5em; border-left: 1px solid #444; }
        .step { margin-bottom: 1.5em; }
        pre { background-color: #272727; padding: 1em; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; max-height: 250px; overflow-y: auto; }
        /* --- END NEW CSS --- */
    </style>
</head>
<body>
    <div class="container">
        <h1>Goal Archive</h1>
        <a href="/" class="back-link">&larr; Back to Live Dashboard</a>
        
        <div id="archive-content">
            {% for goal in goals %}
                <div class="goal status-{{ goal.status }}">
                    <details>
                        <summary><h3>[{{ goal.status.upper() }}] {{ goal.goal }}</h3></summary>
                        
                        <div class="details">
                            {% if goal.plan and goal.plan|length > 0 %}
                                {% for step in goal.plan %}
                                    <div class="step">
                                        <strong>Step {{ step.step_id }} ({{ step.status }}):</strong>
                                        {% if step.tool_call %}
                                            <p>Tool: <code>{{ step.tool_call.tool_name }}</code></p>
                                            <p>Parameters:</p>
                                            <pre>{{ step.tool_call.parameters }}</pre>
                                        {% elif step.prompt %}
                                            <p>Original Prompt:</p>
                                            <pre>{{ step.prompt }}</pre>
                                        {% endif %}
                                        
                                        {% if step.refined_prompt %}
                                            <p>Refined Executor Prompt:</p>
                                            <pre>{{ step.refined_prompt }}</pre>
                                        {% endif %}
                                        
                                        {% if step.output %}
                                            <p>Output:</p>
                                            <pre>{{ step.output }}</pre>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="step"><p>This goal had no executable plan.</p></div>
                            {% endif %}
                            
                            {% if goal.execution_log %}
                                <div class="step">
                                    <strong>Execution Log:</strong>
                                    <pre>{{ goal.execution_log }}</pre>
                                </div>
                            {% endif %}
                        </div>
                        </details>
                </div>
            {% else %}
                <div class="goal"><p>No archived goals found.</p></div>
            {% endfor %}
        </div>

        <div class="pagination">
            {% if page > 1 %}
                <a href="{{ url_for('view_archive', page=page-1) }}">Previous</a>
            {% endif %}
            <span>Page {{ page }} of {{ total_pages }}</span>
            {% if page < total_pages %}
                <a href="{{ url_for('view_archive', page=page+1) }}">Next</a>
            {% endif %}
        </div>
    </div>
</body>
</html>